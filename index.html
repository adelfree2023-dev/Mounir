<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ - Universal Data Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Form */
        .form-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input:read-only {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .form-group input.auto-filled {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--secondary);
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .btn-magic {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* Bulk Section */
        .bulk-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px dashed var(--primary);
            text-align: center;
        }

        .bulk-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-bulk {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-bulk:hover {
            transform: translateY(-2px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress-bar .progress {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.1s;
        }

        /* Table */
        .table-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            background: var(--bg-input);
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 14px;
            border: 2px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
        }

        .pagination button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--secondary);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            transform: translateX(-150%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 id="appTitle">ğŸ“Š Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</h1>
            <p id="appDesc">Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£ØºØ±Ø§Ø¶</p>

            <div
                style="margin-top: 20px; display: inline-block; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 10px;">
                <select id="schemaSelector" onchange="engine.init(this.value)"
                    style="padding: 10px 20px; border-radius: 8px; border: none; font-size: 1.1rem; background: var(--bg-input); color: white; cursor: pointer; min-width: 300px;">
                    <optgroup label="ğŸ¢ Business - Ø£Ø¹Ù…Ø§Ù„">
                        <option value="sales">ğŸ’° Sales - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="employees">ğŸ‘¥ Employees - Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                        <option value="inventory">ğŸ“¦ Inventory - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†</option>
                    </optgroup>
                    <option disabled>CRM - Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                    <option disabled>Marketing - Ø§Ù„ØªØ³ÙˆÙŠÙ‚</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-container" id="statsContainer"></div>

        <!-- Dynamic Form -->
        <div class="form-section">
            <h2>ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="dynamicForm">
                <div class="form-grid" id="formContainer">
                    <!-- Fields will be injected here -->
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-magic" onclick="engine.autoFill()">ğŸ² Ù…Ù„Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
                    <button type="submit" class="btn btn-primary">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</button>
                    <button type="button" class="btn btn-warning" onclick="engine.resetForm()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
                </div>
            </form>
        </div>

        <!-- Bulk Section -->
        <div class="bulk-section">
            <h3>âš¡ ØªÙˆÙ„ÙŠØ¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©</h3>
            <div class="bulk-buttons">
                <button class="btn-bulk" onclick="engine.generateBulk(100)">ğŸ“¦ 100 Ø³Ø¬Ù„</button>
                <button class="btn-bulk" onclick="engine.generateBulk(500)">ğŸ“¦ 500 Ø³Ø¬Ù„</button>
                <button class="btn-bulk" onclick="engine.generateBulk(1000)">ğŸ“¦ 1,000 Ø³Ø¬Ù„</button>
                <button class="btn-bulk" onclick="engine.generateBulk(5000)">ğŸ“¦ 5,000 Ø³Ø¬Ù„</button>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
            </div>
            <p id="progressText" style="margin-top: 10px; display: none;"></p>
        </div>

        <!-- Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h2>
                <div class="table-controls">
                    <input type="text" class="search-box" placeholder="ğŸ” Ø¨Ø­Ø«..."
                        onkeyup="engine.searchTable(this.value)"
                        style="padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: var(--bg-input); color: white;">
                    <button class="btn btn-success" onclick="engine.exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                    <button class="btn btn-danger" onclick="engine.clearAll()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="paginationContainer" class="pagination"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- 1. SCHEMAS DEFINITION ---
        const AppSchemas = {
            sales: {
                id: 'sales',
                title: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
                desc: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŒ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                fields: [
                    { id: 'orderId', label: 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', type: 'text', readonly: true, width: '150px' },
                    { id: 'orderDate', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨', type: 'date', required: true },
                    { id: 'shipDate', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†', type: 'date' },
                    { id: 'deliveryDate', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…', type: 'date' },
                    { id: 'orderStatus', label: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', type: 'select', options: ['Completed', 'Pending', 'Shipped', 'Cancelled', 'Returned'] },
                    { id: 'customerId', label: 'Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', type: 'text', readonly: true },
                    { id: 'customerSegment', label: 'Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„', type: 'select', options: ['Enterprise', 'SMB', 'Individual', 'Government', 'Education'] },
                    { id: 'region', label: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', type: 'select', options: ['North America', 'Europe', 'Asia Pacific', 'Latin America', 'Middle East & Africa'], onChange: 'updateCountries' },
                    { id: 'country', label: 'Ø§Ù„Ø¯ÙˆÙ„Ø©', type: 'select', options: [] }, // Populated dynamically
                    { id: 'productCategory', label: 'ÙØ¦Ø© Ø§Ù„Ù…Ù†ØªØ¬', type: 'select', options: ['Electronics', 'Furniture', 'Office Supplies', 'Clothing', 'Food & Beverages'], onChange: 'updateProducts' },
                    { id: 'productName', label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', type: 'select', options: [] }, // Populated dynamically
                    { id: 'quantity', label: 'Ø§Ù„ÙƒÙ…ÙŠØ©', type: 'number', required: true, onChange: 'calculateTotals' },
                    { id: 'unitPrice', label: 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', type: 'number', required: true, onChange: 'calculateTotals' },
                    { id: 'grossSales', label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', type: 'money', readonly: true },
                    { id: 'discountPercent', label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %', type: 'select', options: [0, 5, 10, 15, 20, 25], onChange: 'calculateTotals' },
                    { id: 'discountAmount', label: 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…', type: 'money', readonly: true },
                    { id: 'netSales', label: 'ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', type: 'money', readonly: true },
                    { id: 'costOfGoods', label: 'ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©', type: 'number', onChange: 'calculateTotals' },
                    { id: 'profit', label: 'Ø§Ù„Ø±Ø¨Ø­', type: 'money', readonly: true },
                    { id: 'profitMargin', label: 'Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ %', type: 'percent', readonly: true },
                    { id: 'salesChannel', label: 'Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ¹', type: 'select', options: ['Direct Sales', 'Online', 'Retail', 'Partner', 'Distributor'] },
                    { id: 'paymentMethod', label: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', type: 'select', options: ['Credit Card', 'Bank Transfer', 'PayPal', 'Check', 'Cash'] },
                    { id: 'salesRepName', label: 'Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', type: 'select', options: [] } // Populated from config
                ],
                config: {
                    countriesByRegion: {
                        'North America': ['USA', 'Canada', 'Mexico'],
                        'Europe': ['Germany', 'UK', 'France', 'Italy', 'Spain', 'Netherlands'],
                        'Asia Pacific': ['China', 'Japan', 'India', 'Australia', 'Singapore', 'South Korea'],
                        'Latin America': ['Brazil', 'Argentina', 'Chile', 'Colombia', 'Peru'],
                        'Middle East & Africa': ['UAE', 'Saudi Arabia', 'South Africa', 'Egypt', 'Nigeria']
                    },
                    productsByCategory: {
                        'Electronics': ['Laptop', 'Desktop Computer', 'Tablet', 'Smartphone', 'Monitor'],
                        'Furniture': ['Office Chair', 'Desk', 'Filing Cabinet', 'Sofa'],
                        'Office Supplies': ['Paper', 'Pens', 'Notebooks', 'Binders'],
                        'Clothing': ['Suit', 'Shirt', 'Pants', 'Shoes'],
                        'Food & Beverages': ['Coffee', 'Tea', 'Snacks', 'Water']
                    },
                    salesReps: ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 'Jennifer Lee']
                },
                handlers: {
                    updateCountries: (val, form) => {
                        const countries = AppSchemas.sales.config.countriesByRegion[val] || [];
                        engine.populateSelect('country', countries);
                    },
                    updateProducts: (val, form) => {
                        const products = AppSchemas.sales.config.productsByCategory[val] || [];
                        engine.populateSelect('productName', products);
                    },
                    calculateTotals: (form) => {
                        const qty = parseFloat(form['quantity'].value) || 0;
                        const price = parseFloat(form['unitPrice'].value) || 0;
                        const discPct = parseFloat(form['discountPercent'].value) || 0;
                        const cost = parseFloat(form['costOfGoods'].value) || 0;

                        const gross = qty * price;
                        const discAmt = gross * (discPct / 100);
                        const net = gross - discAmt;
                        const profit = net - cost;
                        const margin = net > 0 ? (profit / net) * 100 : 0;

                        form['grossSales'].value = gross.toFixed(2);
                        form['discountAmount'].value = discAmt.toFixed(2);
                        form['netSales'].value = net.toFixed(2);
                        form['profit'].value = profit.toFixed(2);
                        form['profitMargin'].value = margin.toFixed(2);
                    }
                }
            },

            employees: {
                id: 'employees',
                title: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© HR',
                desc: 'Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŒ ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…',
                fields: [
                    { id: 'empId', label: 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù', type: 'text', readonly: true },
                    { id: 'fullName', label: 'Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ', type: 'text' },
                    { id: 'department', label: 'Ø§Ù„Ù‚Ø³Ù…', type: 'select', options: ['HR', 'IT', 'Marketing', 'Sales', 'Finance', 'Operations'] },
                    { id: 'position', label: 'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ', type: 'select', options: ['Manager', 'Senior Developer', 'Junior Developer', 'Accountant', 'HR Specialist', 'Sales Rep'] },
                    { id: 'joinDate', label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†', type: 'date' },
                    { id: 'contractType', label: 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯', type: 'select', options: ['Full Time', 'Part Time', 'Freelance', 'Contract'] },
                    { id: 'basicSalary', label: 'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', type: 'number', required: true, onChange: 'calcSalary' },
                    { id: 'incentives', label: 'Ø§Ù„Ø­ÙˆØ§ÙØ²', type: 'number', onChange: 'calcSalary' },
                    { id: 'deductions', label: 'Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª', type: 'number', onChange: 'calcSalary' },
                    { id: 'netSalary', label: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨', type: 'money', readonly: true },
                    { id: 'status', label: 'Ø§Ù„Ø­Ø§Ù„Ø©', type: 'select', options: ['Active', 'On Leave', 'Resigned', 'Terminated'] }
                ],
                config: {},
                handlers: {
                    calcSalary: (val, form) => {
                        const basic = parseFloat(form['basicSalary'].value) || 0;
                        const inc = parseFloat(form['incentives'].value) || 0;
                        const ded = parseFloat(form['deductions'].value) || 0;
                        form['netSalary'].value = (basic + inc - ded).toFixed(2);
                    }
                }
            },

            inventory: {
                id: 'inventory',
                title: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª',
                desc: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ø­Ø±ÙƒØ© Ø§Ù„Ø£ØµÙ†Ø§ÙØŒ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£ØµÙˆÙ„',
                fields: [
                    { id: 'sku', label: 'ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù (SKU)', type: 'text', readonly: true },
                    { id: 'itemName', label: 'Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù', type: 'text', required: true },
                    { id: 'category', label: 'Ø§Ù„ØªØµÙ†ÙŠÙ', type: 'select', options: ['Raw Materials', 'Finished Goods', 'Packaging', 'Spares', 'Electronics'] },
                    { id: 'warehouse', label: 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹', type: 'select', options: ['Main Warehouse', 'Distribution Center', 'Retail Store', 'Cold Storage'] },
                    { id: 'binLocation', label: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Ref)', type: 'text' },
                    { id: 'unit', label: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³', type: 'select', options: ['Pcs', 'Kg', 'Box', 'Liter', 'Meter'] },
                    { id: 'qtyOnHand', label: 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', type: 'number', required: true, onChange: 'calcVal' },
                    { id: 'minLevel', label: 'Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨', type: 'number' },
                    { id: 'maxLevel', label: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰', type: 'number' },
                    { id: 'unitCost', label: 'ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©', type: 'number', required: true, onChange: 'calcVal' },
                    { id: 'totalValue', label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©', type: 'money', readonly: true },
                    { id: 'status', label: 'Ø§Ù„Ø­Ø§Ù„Ø©', type: 'select', options: ['In Stock', 'Low Stock', 'Out of Stock', 'Discontinued'] },
                    { id: 'lastRestock', label: 'Ø¢Ø®Ø± ØªÙˆØ±ÙŠØ¯', type: 'date' },
                    { id: 'supplier', label: 'Ø§Ù„Ù…ÙˆØ±Ø¯', type: 'select', options: ['TechImport Ltd', 'Global Supplies', 'Local Traders', 'Factory Direct'] }
                ],
                config: {},
                handlers: {
                    calcVal: (val, form) => {
                        const qty = parseFloat(form['qtyOnHand'].value) || 0;
                        const cost = parseFloat(form['unitCost'].value) || 0;
                        form['totalValue'].value = (qty * cost).toFixed(2);
                    }
                }
            }
        };

        // --- 2. ENGINE CORE ---
        const engine = {
            currentSchema: null,
            data: [],
            currentPage: 1,
            itemsPerPage: 25,
            editingIndex: -1,
            orderCounter: 1,

            init: function (schemaId) {
                // Switch Schema Logic
                if (this.currentSchema && this.currentSchema.id === schemaId) return;

                this.currentSchema = AppSchemas[schemaId];

                // Update dropdown if not matches (e.g. on first load)
                document.getElementById('schemaSelector').value = schemaId;

                this.loadData();
                this.renderUI();

                // Initialize Reps if sales
                if (schemaId === 'sales') {
                    this.populateSelect('salesRepName', this.currentSchema.config.salesReps);
                }

                // Submit Handler (Remove old listener to avoid duplicates if any)
                const oldForm = document.getElementById('dynamicForm');
                const newForm = oldForm.cloneNode(true);
                oldForm.parentNode.replaceChild(newForm, oldForm);

                newForm.onsubmit = (e) => {
                    e.preventDefault();
                    this.saveRecord();
                };
            },

            loadData: function () {
                const key = `data_${this.currentSchema.id}`;
                this.data = JSON.parse(localStorage.getItem(key)) || [];
                this.orderCounter = parseInt(localStorage.getItem(`counter_${this.currentSchema.id}`)) || 1;
            },

            renderUI: function () {
                document.getElementById('appTitle').textContent = `ğŸ“Š ${this.currentSchema.title}`;
                document.getElementById('appDesc').textContent = this.currentSchema.desc;

                this.renderFormBuilder();
                this.renderTableHeaders();
                this.renderTableBody();
                this.updateStats();
                this.resetForm(); // Sets defaults
            },

            renderFormBuilder: function () {
                const container = document.getElementById('formContainer');
                container.innerHTML = this.currentSchema.fields.map(field => `
                    <div class="form-group">
                        <label>${field.label} ${field.required ? '*' : ''}</label>
                        ${this.getFieldHTML(field)}
                    </div>
                `).join('');

                // Add Event Listeners
                this.currentSchema.fields.forEach(field => {
                    if (field.onChange) {
                        const el = document.getElementById(field.id);
                        el.addEventListener('change', (e) => {
                            this.currentSchema.handlers[field.onChange](e.target.value, document.getElementById('dynamicForm').elements);
                        });
                        // Also trigger for input events for live calc
                        if (field.type === 'number') {
                            el.addEventListener('input', (e) => {
                                this.currentSchema.handlers[field.onChange](e.target.value, document.getElementById('dynamicForm').elements);
                            });
                        }
                    }
                });
            },

            getFieldHTML: function (field) {
                const req = field.required ? 'required' : '';
                const ro = field.readonly ? 'readonly' : '';

                if (field.type === 'select') {
                    return `<select id="${field.id}" ${req} ${ro}>
                        <option value="">Ø§Ø®ØªØ±...</option>
                        ${field.options ? field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('') : ''}
                    </select>`;
                }
                return `<input type="${field.type === 'money' || field.type === 'percent' ? 'text' : field.type}" 
                        id="${field.id}" ${req} ${ro} step="any">`;
            },

            populateSelect: function (id, options) {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>' +
                    options.map(o => `<option value="${o}">${o}</option>`).join('');
            },

            // --- DATA OPERATIONS ---
            saveRecord: function () {
                const form = document.getElementById('dynamicForm');
                const record = {};

                this.currentSchema.fields.forEach(f => {
                    record[f.id] = document.getElementById(f.id).value;
                });

                if (this.editingIndex >= 0) {
                    this.data[this.editingIndex] = record;
                    this.editingIndex = -1;
                    this.showToast('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    this.data.push(record);
                    this.orderCounter++;
                    localStorage.setItem(`counter_${this.currentSchema.id}`, this.orderCounter);
                    this.showToast('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                }

                this.saveToStorage();
                this.renderTableBody();
                this.updateStats();
                this.resetForm();
            },

            saveToStorage: function () {
                localStorage.setItem(`data_${this.currentSchema.id}`, JSON.stringify(this.data));
            },

            // --- TABLE & DISPLAY ---
            renderTableHeaders: function () {
                const thead = document.getElementById('tableHead');
                const headers = ['Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª', ...this.currentSchema.fields.map(f => f.label)];
                thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            },

            renderTableBody: function () {
                const tbody = document.getElementById('tableBody');
                const container = document.getElementById('paginationContainer');

                if (this.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="100" style="text-align:center; padding: 50px;">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    container.innerHTML = '';
                    return;
                }

                const totalPages = Math.ceil(this.data.length / this.itemsPerPage);
                if (this.currentPage > totalPages) this.currentPage = totalPages;

                const start = (this.currentPage - 1) * this.itemsPerPage;
                const pageData = this.data.slice(start, start + this.itemsPerPage);

                tbody.innerHTML = pageData.map((row, i) => {
                    const actualIndex = start + i;
                    const cells = this.currentSchema.fields.map(f => `<td>${this.formatVal(row[f.id], f.type)}</td>`).join('');
                    return `<tr>
                        <td class="actions">
                            <button class="btn btn-danger btn-sm" onclick="engine.deleteRecord(${actualIndex})">ğŸ—‘ï¸</button>
                            <button class="btn btn-primary btn-sm" onclick="engine.editRecord(${actualIndex})">âœï¸</button>
                        </td>
                        ${cells}
                    </tr>`;
                }).join('');

                this.renderPagination(totalPages);
            },

            formatVal: function (val, type) {
                if (type === 'money') return val ? `$${Number(val).toFixed(2)}` : '';
                if (type === 'percent') return val ? `${val}%` : '';
                return val || '';
            },

            renderPagination: function (totalPages) {
                const con = document.getElementById('paginationContainer');
                if (totalPages <= 1) { con.innerHTML = ''; return; }

                let html = `<button onclick="engine.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>â—€</button>`;
                html += `<span class="pagination-info">${this.currentPage} / ${totalPages}</span>`;
                html += `<button onclick="engine.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}>â–¶</button>`;
                con.innerHTML = html;
            },

            goToPage: function (p) {
                this.currentPage = p;
                this.renderTableBody();
            },

            // --- ACTIONS ---
            editRecord: function (index) {
                this.editingIndex = index;
                const rec = this.data[index];

                // Triggers generic fill
                this.currentSchema.fields.forEach(f => {
                    const el = document.getElementById(f.id);
                    if (el) {
                        // Handlers need to run to populate dependents 
                        if (f.id === 'region') this.currentSchema.handlers.updateCountries(rec[f.id]);
                        if (f.id === 'productCategory') this.currentSchema.handlers.updateProducts(rec[f.id]);

                        el.value = rec[f.id];
                    }
                });

                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.showToast('ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
            },

            deleteRecord: function (index) {
                if (confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) {
                    this.data.splice(index, 1);
                    this.saveToStorage();
                    this.renderTableBody();
                    this.updateStats();
                }
            },

            clearAll: function () {
                if (confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                    this.data = [];
                    this.saveToStorage();
                    this.renderTableBody();
                    this.updateStats();
                }
            },

            resetForm: function () {
                document.getElementById('dynamicForm').reset();
                this.editingIndex = -1;

                // Defaults
                if (this.currentSchema.id === 'sales') {
                    const year = new Date().getFullYear();
                    const el = document.getElementById('orderId');
                    if (el) el.value = `ORD-${year}-${String(this.orderCounter).padStart(5, '0')}`;

                    const cust = document.getElementById('customerId');
                    if (cust) cust.value = `CUST-${Math.floor(Math.random() * 9000) + 1000}`;

                    const date = document.getElementById('orderDate');
                    if (date) date.value = new Date().toISOString().split('T')[0];
                }
                else if (this.currentSchema.id === 'employees') {
                    const el = document.getElementById('empId');
                    if (el) el.value = `EMP-${String(this.orderCounter).padStart(4, '0')}`;

                    const date = document.getElementById('joinDate');
                    if (date) date.value = new Date().toISOString().split('T')[0];
                }
                else if (this.currentSchema.id === 'inventory') {
                    const el = document.getElementById('sku');
                    if (el) el.value = `SKU-${Math.floor(Math.random() * 100000) + 1000}`;

                    const date = document.getElementById('lastRestock');
                    if (date) date.value = new Date().toISOString().split('T')[0];
                }
            },

            updateStats: function () {
                const con = document.getElementById('statsContainer');
                // Generic simple stats for now
                con.innerHTML = `
                    <div class="stat-card">
                        <div class="value">${this.data.length.toLocaleString()}</div>
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
                    </div>
                 `;
            },

            showToast: function (msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            // --- GENERATORS ---
            autoFill: function () {
                this.currentSchema.fields.forEach(f => {
                    const el = document.getElementById(f.id);
                    if (!el || (f.readonly && f.id !== 'grossSales' && f.id !== 'netSalary' && f.id !== 'totalValue')) return;

                    let val = '';
                    if (f.options) {
                        val = f.options[Math.floor(Math.random() * f.options.length)];
                    } else if (f.type === 'number') {
                        val = Math.floor(Math.random() * 100) + 1;
                    } else if (f.type === 'date') {
                        const d = new Date(new Date().getTime() - Math.random() * 10000000000);
                        val = d.toISOString().split('T')[0];
                    } else if (f.id === 'fullName' || f.id === 'itemName') {
                        val = `Item ${Math.floor(Math.random() * 1000)}`;
                        if (f.id === 'fullName') val = ['Ahmed', 'Mohamed', 'Sarah', 'Lina'][Math.floor(Math.random() * 4)] + ' ' + ['Ali', 'Hassan', 'Smith', 'Jones'][Math.floor(Math.random() * 4)];
                    }

                    if (f.onChange) {
                        // We need to set val and trigger custom logic manually or simulate event
                        if (el) { el.value = val; this.currentSchema.handlers[f.onChange](val, document.getElementById('dynamicForm').elements); }
                    } else {
                        if (el) el.value = val;
                    }

                    if (el) {
                        el.classList.add('auto-filled');
                        setTimeout(() => el.classList.remove('auto-filled'), 1000);
                    }
                });
            },

            generateBulk: async function (count) {
                const progressBar = document.getElementById('progressBar');
                const progress = document.getElementById('progress');
                const progressText = document.getElementById('progressText');

                progressBar.style.display = 'block';
                progressText.style.display = 'block';
                progress.style.width = '0%';

                const batchSize = 100;
                let added = 0;

                // Create a virtual form context to reuse handlers
                const virtualForm = {};

                for (let i = 0; i < count; i++) {
                    const record = {};

                    // Generate basic fields
                    this.currentSchema.fields.forEach(f => {
                        let val = '';
                        if (f.options) {
                            val = f.options[Math.floor(Math.random() * f.options.length)];
                        } else if (f.type === 'number') {
                            val = Math.floor(Math.random() * 500) + 10;
                            if (f.id === 'basicSalary') val = 3000 + Math.floor(Math.random() * 5000);
                        } else if (f.type === 'date') {
                            val = new Date(2023, 0, 1 + Math.floor(Math.random() * 365)).toISOString().split('T')[0];
                        } else if (f.id === 'fullName') {
                            val = ['Ahmed', 'Mohamed', 'Sarah', 'Lina'][Math.floor(Math.random() * 4)] + ' ' + ['Ali', 'Hassan', 'Smith', 'Jones'][Math.floor(Math.random() * 4)];
                        } else if (f.id === 'itemName') {
                            val = `Product ${Math.floor(Math.random() * 1000)}`;
                        }

                        // Auto-IDs
                        if (f.id === 'orderId') val = `ORD-${2024}-${String(this.orderCounter + i).padStart(5, '0')}`;
                        if (f.id === 'empId') val = `EMP-${String(this.orderCounter + i).padStart(4, '0')}`;
                        if (f.id === 'sku') val = `SKU-${Math.floor(Math.random() * 100000)}`;
                        if (f.id === 'customerId') val = `CUST-${Math.floor(Math.random() * 9000) + 1000}`;

                        record[f.id] = val;
                        // Populate virtual form for calculations
                        virtualForm[f.id] = { value: val };
                    });

                    // Run calculations
                    this.currentSchema.fields.forEach(f => {
                        if (f.onChange && this.currentSchema.handlers[f.onChange]) {
                            // Create a proxy to simulate form elements
                            const handler = this.currentSchema.handlers[f.onChange];
                            // We need a way to set the calculated output back to 'record'
                            // This is a bit tricky without DOM. 
                            // Simplified approach: Custom logic per schema for bulk
                            if (this.currentSchema.id === 'sales') {
                                const q = record['quantity']; const p = record['unitPrice']; const d = record['discountPercent']; const c = record['costOfGoods'] || (q * p * 0.6);
                                record['grossSales'] = (q * p).toFixed(2);
                                record['discountAmount'] = (q * p * d / 100).toFixed(2);
                                record['netSales'] = (q * p - q * p * d / 100).toFixed(2);
                                record['costOfGoods'] = c.toFixed(2);
                                record['profit'] = (parseFloat(record['netSales']) - c).toFixed(2);
                                record['profitMargin'] = (parseFloat(record['profit']) / parseFloat(record['netSales']) * 100).toFixed(2);
                            } else if (this.currentSchema.id === 'employees') {
                                const b = record['basicSalary']; const inc = record['incentives'] || 0; const ded = record['deductions'] || 0;
                                record['netSalary'] = (b + inc - ded).toFixed(2);
                            } else if (this.currentSchema.id === 'inventory') {
                                record['totalValue'] = (record['qtyOnHand'] * record['unitCost']).toFixed(2);
                            }
                        }
                    });

                    this.data.push(record);
                    added++;

                    if (added % batchSize === 0 || added === count) {
                        const percent = Math.round((added / count) * 100);
                        progress.style.width = percent + '%';
                        progressText.textContent = `${added.toLocaleString()} / ${count.toLocaleString()}`;
                        await new Promise(r => setTimeout(r, 0));
                    }
                }

                this.orderCounter += count;
                localStorage.setItem(`counter_${this.currentSchema.id}`, this.orderCounter);
                this.saveToStorage();
                this.renderTableBody();
                this.updateStats();

                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressText.style.display = 'none';
                    this.showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${count} Ø³Ø¬Ù„!`);
                }, 500);
            },

            exportExcel: function () {
                const ws = XLSX.utils.json_to_sheet(this.data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `${this.currentSchema.id}_data.xlsx`);
            },

            searchTable: function (q) {
                q = q.toLowerCase();
                const rows = document.querySelectorAll('#tableBody tr');
                rows.forEach(r => {
                    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
                });
            }
        };

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            // Migrate old data if exists to new key
            const oldData = localStorage.getItem('salesData');
            if (oldData && !localStorage.getItem('data_sales')) {
                localStorage.setItem('data_sales', oldData);
            }

            engine.init('sales');
        });
    </script>
</body>

</html>